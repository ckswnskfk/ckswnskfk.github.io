---
title: "[66해빗 페이백 챌린지] 3일차"
excerpt: "이벤트 루프"
categories:
  - Browser
  - javascript
  - TIL
tags:
  - f-lab
  - 에프랩
  - Browser
  - javascript
  - Event loop
last_modified_at: 2023-05-22
toc: true
---

javascript는 단일 쓰레드 언어이다. 하나의 콜 스택에 실행 컨텍스트가 쌓이며 그 최상단에 위치한 함수만 실행할 수 있고 그 외에 다른 동작을 할수 없는 것이다.

그런데 우리가 javascript를 사용하는 환경, 즉 브라우저에서는 정말로 한 번에 한 가지 일 밖에 하지 못할까? 그렇지 않다. 우리는 브라우저가 서버에 요청을 보내고 받는 도중에도 페이지의 랜더링 동작은 멈추지 않는 경험을 한다. 한 번에 한 가지 작업밖에 하지 못한다면 사용자 경험이 너무나 크게 저해되기 때문에, 브라우저(및 node.js. javascript 실행 환경)는 **Web API**와 **이벤트 루프**를 제공해 동시성 이슈를 해결한다.

# Web API

브라우저에서 제공하는 API로 비동기 동작과 관련된 건 DOM, Ajax, TimeOut이 있다. 콜 스택에 호출된 함수중 비동기 함수는 Web API에서 실행된다. Web API에서 필요한 작업을 마친 후(setTimeout 의 경우 인자로 받은 밀리세컨드 이후) 인자로 받은 콜백 함수를 콜백 큐(Callback Queue)로 전달한다.

## 콜백 큐

콜백 큐는 비동기 함수의 콜백 함수를 보관해주는 역할을 한다.

Web API에서 콜백 함수를 전달해주면 콜백 큐는 이 콜백 함수들을 보관해주며 이벤트 루프가 콜백 함수를 가져가기를 기다린다.

## 이벤트 루트

이벤트 루프는 콜 스택이 비어있을 때 콜백 큐에서 콜백 함수를 가져와 콜 스택에 전달하는 역할을 한다. 즉 아래와 같은 역할을 한다.

- 콜스택에 함수들이 있는지 확인하는 역할
- 콜백 큐에 콜백 함수가 있는지 확인하는 역할
- 콜백 큐로부터 콜스택에 콜백함수를 가져다주는 역할

한 가지 더 추가적으로 알아보자면, 사실 콜백 큐는 세 부분으로 나뉜다. Task Queue와 MicroTask Queue, Animation Frames 가 그것이다.

위에서 살펴본 DOM, Ajax, TimeOut은 Task Queue에서 관리 되고, Promise, Observer API 등은 MicroTask Queue에서 관리된다.

중요한 점은 MicroTask Queue가 일반 Task Queue보다 더 높은 우선순위를 갖는다는 것이다. 그래서 결국은 아래와 같은 순서로 콜백 함수를 반환하게 되는데

1. 마이크로 태스크가 있는지 먼저 확인하고, 있다면 모든 마이크로 태스크를 먼저 수행한다.
2. 처리할 태스크가 있다면 가장 오래된 태스크를 실행한다.
3. 처리할 태스크가 없다면 다음 태스크를 기다린다.
4. 다시 처리할 작업이 있다면 1번으로 돌아가 반복한다.

그렇다면 Animation Frames의 우선순위는 어떻게 될까?

우선순위가 따로 정해져 있다기보단, 화면 갱신이 필요하면 이벤트 루프가 렌더링 파이프 라인으로 이동해 화면 갱신 이전에 requestAnimationFrame을 실행한다.

## 문제

이렇듯 자바스크립트 엔진 외부의 도움을 받아 비동기적으로 작동할 수 있지만, 문제가 없는것은 아니다. 콜 스택은 여전히 하나이기에 고비용의 연산이 실행되고 있다면 다른 동작을 할 수 없는 것은 마찬가지이기 때문이다. 그렇다면 이 문제를 엔지니어로써 어떻게 해결할 수 있을까?

크게 두 가지 방법이 제시된다. 하나는 단일 콜 스택 구조 때문에 블록이 발생하고 있으니 다른 스레드에 작업을 위임하는 방법(웹 워커)이고, 또 다른 하나는 블로킹의 원인이 되는 고비용 작업을 적절하게 쪼개서 실행하는(스케쥴링) 방법이다.
